import streamlit as st
import pandas as pd
import requests

# ---------------------------
# ν™κ²½λ³€μ(API ν‚¤) β†’ Streamlit secrets.toml μ— μ €μ¥ ν•„μ
# ---------------------------
GOOGLE_API_KEY = st.secrets["GOOGLE_API_KEY"]

# ---------------------------
# Google Places APIλ΅ μμ‹μ  μ¶”μ² κ°€μ Έμ¤κΈ°
# ---------------------------
def get_top_restaurants(city, keyword="restaurant", limit=3):
    url = f"https://maps.googleapis.com/maps/api/place/textsearch/json"
    params = {
        "query": f"{city} {keyword}",
        "key": GOOGLE_API_KEY,
        "language": "ko"
    }
    response = requests.get(url, params=params).json()

    results = []
    if "results" in response:
        for r in response["results"][:limit]:
            name = r.get("name")
            rating = r.get("rating", "N/A")
            address = r.get("formatted_address", "")
            results.append(f"{name} (β­{rating}) - {address}")
    return results

# ---------------------------
# μ—¬ν–‰ λ°μ΄ν„°λ² μ΄μ¤
# ---------------------------
travel_data = {
    "μΌλ³Έ": {
        "λ§μ΅±λ„": 4.7,
        "λ„μ‹": {"λ„μΏ„": ["μ”μ½”ν•λ§", "κ°€λ§μΏ λΌ"], "μ¤μ‚¬μΉ΄": ["κµν† ", "κ³ λ² "]},
        "λ¶νΈν•μ ": ["μμ–΄ μ†ν†µ μ–΄λ ¤μ›€", "κµν†µλΉ„ λΉ„μ", "ν„κΈ μ‚¬μ© λΉ„μ¨ λ†’μ"],
        "μ„μƒ": "μ „λ°μ μΌλ΅ μ²­κ²°ν•μ§€λ§, μΌλ¶€ μ¤λλ μ‹λ‹Ήμ—μ„λ” μ„μƒ μμ¤€μ΄ λ‚®μ„ μ μμ.",
        "λ¬Έν™”": {
            "μ§€μΌμ•Ό ν•λ” λ¬Έν™”": ["μ „μ² μ—μ„ ν†µν™” κΈμ§€", "μ“°λ κΈ° λ¶„λ¦¬μκ±° μ² μ €", "μ‹μ‚¬ μ „ 'μ΄νƒ€λ‹¤ν‚¤λ§μ¤' μΈμ‚¬"],
            "μΌλ° λ¬Έν™”": ["μ¨μ² λ¬Έν™” λ°λ‹¬", "λ§ν™”Β·μ• λ‹λ©”μ΄μ… κ°•κµ­", "μ‚¬μΌ€μ™€ λΌλ© λ“± λ‹¤μ–‘ν• μμ‹ λ¬Έν™”"]
        }
    },
    "νƒκµ­": {
        "λ§μ΅±λ„": 4.4,
        "λ„μ‹": {"λ°©μ½•": ["μ•„μ νƒ€μ•Ό", "ννƒ€μ•Ό"], "ν‘ΈμΌ“": ["ν”Όν”Όμ„¬", "ν΅μ•„"]},
        "λ¶νΈν•μ ": ["λ”μ΄ λ‚ μ”¨", "κµν†µ νΌμ΅", "μ„μƒ λ¬Έμ "],
        "μ„μƒ": "κ΄€κ΄‘μ§€ νΈν…”Β·λ μ¤ν† λ‘μ€ μ„μƒμ μ΄λ‚, κΈΈκ±°λ¦¬ μμ‹μ€ μ΅°μ‹¬ ν•„μ”.",
        "λ¬Έν™”": {
            "μ§€μΌμ•Ό ν•λ” λ¬Έν™”": ["μ™•μ‹¤ λΉ„ν κΈμ§€", "μ‚¬μ› λ°©λ¬Έ μ‹ λ³µμ¥ κ·μΉ™ μ¤€μ", "λ¨Έλ¦¬ μ“°λ‹¤λ“¬κΈ° κΈμ§€"],
            "μΌλ° λ¬Έν™”": ["λ―Έμ†μ λ‚λΌ", "λ¶κµ λ¬Έν™” μ¤‘μ‹¬", "κΈΈκ±°λ¦¬ μμ‹ λ‹¤μ–‘ν•¨"]
        }
    },
    "λ² νΈλ‚¨": {
        "λ§μ΅±λ„": 4.5,
        "λ„μ‹": {"ν•λ…Έμ΄": ["ν•λ΅±λ² μ΄", "λ‹λΉ"], "νΈμΉλ―Ό": ["λ©”μ½©λΈνƒ€", "λ¶•λ”°μ°"]},
        "λ¶νΈν•μ ": ["μ¤ν† λ°”μ΄ κµν†µ μ„ν—", "μ–Έμ–΄ μ¥λ²½", "λ‚ μ”¨ λ”μ›€"],
        "μ„μƒ": "λ€λ„μ‹ κ΄€κ΄‘μ§€λ” λΉ„κµμ  κΉ¨λ—ν•μ§€λ§, λ…Έμ  μμ‹μ€ μ„μƒ λ¬Έμ  κ°€λ¥.",
        "λ¬Έν™”": {
            "μ§€μΌμ•Ό ν•λ” λ¬Έν™”": ["νΈμΉ­Β·μμ μ¤‘μ‹", "μ‹¤λ‚΄ μ‹ λ° λ²—κΈ°", "νΈμΉλ―Ό μ΅΄κ²½"],
            "μΌλ° λ¬Έν™”": ["μ»¤ν”Ό λ¬Έν™” λ°λ‹¬", "μ€κµ­μ(ν¬) μ λ…", "μ‹μ¥ λ¬Έν™” ν™λ°"]
        }
    },
    "λ―Έκµ­": {
        "λ§μ΅±λ„": 4.3,
        "λ„μ‹": {"λ‰΄μ•": ["λ‰΄μ €μ§€", "λ³΄μ¤ν„΄"], "LA": ["μƒλ””μ—μ΄κ³ ", "λΌμ¤λ² κ°€μ¤"]},
        "λ¶νΈν•μ ": ["ν λ¬Έν™” λ¶€λ‹΄", "μ΄κΈ° μ•μ „ λ¬Έμ ", "λ¬Όκ°€ λΉ„μ"],
        "μ„μƒ": "λ€μ²΄λ΅ μ„μƒμ μ΄λ‚, μΌλ¶€ μ§€μ—­ λ…Έμ™μ λ¬Έμ  μ΅΄μ¬.",
        "λ¬Έν™”": {
            "μ§€μΌμ•Ό ν•λ” λ¬Έν™”": ["μ‹λ‹Ή ν λ¬Έν™” ν•„μ(15~20%)", "κ³µκ³µμ¥μ† ν΅μ—° κΈμ§€", "κ°μΈ κ³µκ°„ μ΅΄μ¤‘"],
            "μΌλ° λ¬Έν™”": ["λ‹¤λ―Όμ΅± μ‚¬ν", "ν¨μ¤νΈν‘Έλ“ λ°λ‹¬", "μ¤ν¬μΈ  λ¬Έν™” (NBA, NFL) κ°•μ„Έ"]
        }
    },
    "ν”„λ‘μ¤": {
        "λ§μ΅±λ„": 4.5,
        "λ„μ‹": {"νλ¦¬": ["λ² λ¥΄μ‚¬μ ", "λ½μƒλ―Έμ…Έ"], "λ‹μ¤": ["μΉΈ", "λ¨λ‚μ½”"]},
        "λ¶νΈν•μ ": ["μ†λ§¤μΉκΈ° μ£Όμ", "λ¬Όκ°€ λΉ„μ", "ν”„λ‘μ¤μ–΄ μ†ν†µ ν•„μ”"],
        "μ„μƒ": "μ‹λ‹Ή μ„μƒμ€ λ€μ²΄λ΅ κ΄μ°®μ§€λ§, μΌλ¶€ κ³µκ³µ ν™”μ¥μ‹¤μ€ λ¶νΈν•  μ μμ.",
        "λ¬Έν™”": {
            "μ§€μΌμ•Ό ν•λ” λ¬Έν™”": ["ν”„λ‘μ¤μ–΄ κΈ°λ³Έ μΈμ‚¬ ν•„μ", "μ‹μ‚¬ μμ  μ¤‘μ‹", "λ°•λ¬Όκ΄€ μ΅°μ©ν κ΄€λ"],
            "μΌλ° λ¬Έν™”": ["μ™€μΈκ³Ό μΉμ¦ λ¬Έν™”", "ν¨μ… μ¤‘μ‹¬μ§€", "μμ κ³Ό κ±΄μ¶•μ λ‚λΌ"]
        }
    },
}

# ---------------------------
# Streamlit UI
# ---------------------------
st.set_page_config(page_title="ν•΄μ™Έμ—¬ν–‰ μ¶”μ² κ°€μ΄λ“", page_icon="π", layout="centered")
st.title("π ν•κµ­μΈ μΈκΈ° ν•΄μ™Έμ—¬ν–‰ κ°€μ΄λ“")

country = st.selectbox("κ°€κ³  μ‹¶μ€ λ‚λΌλ¥Ό μ„ νƒν•μ„Έμ”:", list(travel_data.keys()))

if country:
    data = travel_data[country]
    st.header(f"π‡¨π‡­ {country} μ—¬ν–‰ μ •λ³΄")

    # λ§μ΅±λ„
    st.metric("μ—¬ν–‰ λ§μ΅±λ„ (5μ  λ§μ )", f"{data['λ§μ΅±λ„']}")

    # λ„μ‹ + μ†λ„μ‹
    st.subheader("π“ μ¶”μ² λ„μ‹ & μ†λ„μ‹")
    for city, small_cities in data["λ„μ‹"].items():
        st.write(f"- **{city}** β {', '.join(small_cities)}")

        # μμ‹μ  μ¶”μ²
        with st.spinner(f"{city} λ§›μ§‘ κ²€μƒ‰ μ¤‘..."):
            restaurants = get_top_restaurants(city, "λ§›μ§‘", 3)
        st.write("π½οΈ μ¶”μ² μμ‹μ  (Google ν‰μ  κΈ°μ¤€)")
        for r in restaurants:
            st.write(f"   β€Ά {r}")

    # λ¶νΈν• μ 
    st.subheader("β οΈ μ—¬ν–‰ μ‹ λ¶νΈν• μ ")
    for issue in data["λ¶νΈν•μ "]:
        st.write(f"- {issue}")

    # μ„μƒ
    st.subheader("π§Ό μ„μƒ μ •λ³΄")
    st.write(data["μ„μƒ"])

    # λ¬Έν™”
    st.subheader("π λ¬Έν™” μ •λ³΄")
    st.write("β… **μ§€μΌμ•Ό ν•λ” λ¬Έν™”**")
    for rule in data["λ¬Έν™”"]["μ§€μΌμ•Ό ν•λ” λ¬Έν™”"]:
        st.write(f"- {rule}")
    st.write("π **μΌλ° λ¬Έν™”**")
    for c in data["λ¬Έν™”"]["μΌλ° λ¬Έν™”"]:
        st.write(f"- {c}")

    # λ§μ΅±λ„ λΉ„κµ κ·Έλν”„
    st.subheader("π“ λ‚λΌλ³„ μ—¬ν–‰ λ§μ΅±λ„ λΉ„κµ")
    df = pd.DataFrame({
        "λ‚λΌ": list(travel_data.keys()),
        "λ§μ΅±λ„": [travel_data[c]["λ§μ΅±λ„"] for c in travel_data]
    })
    st.bar_chart(df.set_index("λ‚λΌ"))

st.write("---")
st.info("β„ΉοΈ μμ‹μ  ν‰μ  λ°μ΄ν„°λ” Google Places API(λλ” Naver μ§€λ„ API)λ¥Ό ν†µν•΄ μ‹¤μ‹κ°„μΌλ΅ λ¶λ¬μµλ‹λ‹¤.\n"
        "Streamlit Cloudμ—μ„ μ‹¤ν–‰ μ‹, λ°λ“μ‹ `secrets.toml`μ— API ν‚¤λ¥Ό μ €μ¥ν•΄μ•Ό ν•©λ‹λ‹¤.")
